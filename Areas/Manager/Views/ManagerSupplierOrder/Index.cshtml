@model List<PharmacyInventorySystem.ViewModels.ManagerSupplierOrderViewModel>
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

@{
    ViewData["Title"] = "Supplier Orders Overview";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var supplierStats = Model
        .GroupBy(m => m.SupplierName)
        .Select(g => new { SupplierName = g.Key, Count = g.Count() })
        .OrderByDescending(g => g.Count)
        .ToList();

    var chartLabels = string.Join(",", supplierStats.Select(s => $"'{s.SupplierName}'"));
    var chartData = string.Join(",", supplierStats.Select(s => s.Count));
}

@section Styles {
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.bootstrap5.min.css" />
}

<h2 class="mb-4">Supplier Orders Overview</h2>

<div class="mb-5">
    <canvas id="supplierChart" height="100"></canvas>
</div>

@if (Model.Count == 0)
{
    <div class="alert alert-info">No supplier orders have been created yet.</div>
}
else
{
    <table id="ordersTable" class="table table-bordered table-striped">
        <thead class="table-dark">
            <tr>
                <th>#</th>
                <th>Supplier</th>
                <th>Order Date</th>
                <th>Total Amount</th>
                <th>Pharmacist</th>
                <th>Products Count</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @for (int i = 0; i < Model.Count; i++)
            {
                var order = Model[i];
                <tr>
                    <td>@(i + 1)</td>
                    <td>@order.SupplierName</td>
                    <td>@order.SignOrderDate.ToString("yyyy-MM-dd")</td>
                    <td>@order.TotalAmount.ToString("C")</td>
                    <td>@order.PharmacistName</td>
                    <td>@order.ProductsCount</td>
                    <td>
                        <a asp-area="Manager"
                           asp-controller="ManagerSupplierOrder"
                           asp-action="Details"
                           asp-route-id="@order.SupplierOrderID"
                           class="btn btn-sm btn-primary">
                            View
                        </a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@section Scripts {
    <!-- Core Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- DataTables Core -->
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

    <!-- DataTables Export Buttons -->
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <script>
        // DataTable with Export Buttons
        $(document).ready(function () {
            $('#ordersTable').DataTable({
                dom: 'Bfrtip',
                buttons: [
                    'copyHtml5',
                    'excelHtml5',
                    'csvHtml5',
                    'pdfHtml5',
                    'print'
                ]
            });
        });

        // Chart.js for Supplier Orders Count
        const ctx = document.getElementById('supplierChart').getContext('2d');
        const supplierChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: [@Html.Raw(chartLabels)],
                datasets: [{
                    label: 'Number of Orders',
                    data: [@Html.Raw(chartData)],
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { stepSize: 1 }
                    }
                }
            }
        });
    </script>
}
